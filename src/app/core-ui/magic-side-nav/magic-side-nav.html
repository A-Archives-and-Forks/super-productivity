<!-- Mobile Menu Toggle (only visible on mobile) -->
@if (isMobile()) {
  <button
    class="mobile-menu-toggle"
    [class.visible]="isMobile()"
    (click)="toggleSidebar()"
    [attr.aria-label]="showMobileMenu() ? 'Close menu' : 'Open menu'"
    [attr.aria-expanded]="showMobileMenu()"
  >
    <svg
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      @if (!showMobileMenu()) {
        <path d="M3 12h18M3 6h18M3 18h18" />
      }
      @if (showMobileMenu()) {
        <path d="M6 6l12 12M6 18L18 6" />
      }
    </svg>
  </button>
}

<!-- Overlay for mobile (backdrop) -->
@if (isMobile() && showMobileMenu()) {
  <div
    class="nav-overlay"
    [class.visible]="isMobile() && showMobileMenu()"
    (click)="toggleSidebar()"
  ></div>
}

<!-- Main Navigation Sidebar -->
<nav
  class="nav-sidebar"
  [class.expanded]="isExpanded() || (isMobile() && showMobileMenu())"
  [class.collapsed]="!isExpanded() && !isMobile()"
  [class.mobile]="isMobile()"
  [class.mobile-visible]="isMobile() && showMobileMenu()"
  [class.theme-dark]="config.theme === 'dark'"
  [class.position-right]="config.position === 'right'"
  [class.resizing]="isResizing()"
  role="navigation"
>
  <!-- Desktop Toggle Button (inside sidebar) -->
  @if (!isMobile()) {
    <button
      class="sidebar-toggle"
      [class.visible]="!isMobile()"
      (click)="toggleSidebar()"
      [attr.aria-label]="isExpanded() ? 'Collapse sidebar' : 'Expand sidebar'"
      [attr.aria-expanded]="isExpanded()"
    >
      <svg
        width="20"
        height="20"
        viewBox="0 0 20 20"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path [attr.d]="isExpanded() ? 'M13 4l-6 6 6 6' : 'M7 4l6 6-6 6'" />
      </svg>
    </button>
  }

  <!-- Navigation Items -->
  <ul
    class="nav-list"
    role="list"
  >
    @for (item of config.items; track item.id) {
      <!-- Separator item -->
      @if (item.id.startsWith('separator-') && item.label === '' && item.icon === '') {
        <li
          class="nav-separator"
          role="separator"
        ></li>
      } @else {
        <li
          class="nav-item"
          [class.has-children]="item.children && item.children.length > 0"
          role="listitem"
        >
          <!-- Work Context Item (Today/Inbox using side-nav-item) -->
          @if (
            item.workContext && item.workContextType && item.defaultIcon && !item.children
          ) {
            <side-nav-item
              [workContext]="item.workContext"
              [type]="item.workContextType"
              [defaultIcon]="item.defaultIcon"
              [activeWorkContextId]="activeWorkContextId || ''"
              class="work-context-item-main"
            ></side-nav-item>
          } @else if (item.route && (!item.children || item.children.length === 0)) {
            <a
              [routerLink]="item.route"
              routerLinkActive="active"
              class="nav-link"
              [attr.title]="!isExpanded() && !isMobile() ? item.label : null"
              (click)="onItemClick(item)"
            >
              @if (item.svgIcon) {
                <mat-icon
                  class="nav-icon"
                  [svgIcon]="item.svgIcon"
                ></mat-icon>
              } @else {
                <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
              }
              @if (isExpanded() || (isMobile() && showMobileMenu())) {
                <span class="nav-label">{{ item.label | translate }}</span>
              }
              @if (item.badge && (isExpanded() || (isMobile() && showMobileMenu()))) {
                <span class="nav-badge">{{ item.badge }}</span>
              }
            </a>
          }

          @if (!item.route || (item.children && item.children.length > 0)) {
            <!-- Multi-button wrapper for expandable items with additional buttons -->
            @if (item.additionalButtons && item.additionalButtons.length > 0) {
              <div class="g-multi-btn-wrapper">
                <button
                  class="nav-link expand-btn"
                  [class.expanded]="isGroupExpanded(item)"
                  [class.isExpanded]="isGroupExpanded(item)"
                  [attr.title]="!isExpanded() && !isMobile() ? item.label : null"
                  (click)="onItemClick(item)"
                  [attr.aria-expanded]="isGroupExpanded(item)"
                  #expandBtn
                >
                  <!-- Always show icon, even in collapsed mode -->
                  @if (item.svgIcon) {
                    <mat-icon
                      class="nav-icon"
                      [svgIcon]="item.svgIcon"
                    ></mat-icon>
                  } @else {
                    <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
                  }
                  @if (isExpanded() || (isMobile() && showMobileMenu())) {
                    <span class="nav-label title">{{ item.label | translate }}</span>
                  }
                  @if (item.badge && (isExpanded() || (isMobile() && showMobileMenu()))) {
                    <span class="nav-badge">{{ item.badge }}</span>
                  }
                </button>

                <!-- Additional buttons (only show when sidebar is expanded) -->
                @if (isExpanded() || (isMobile() && showMobileMenu())) {
                  @for (btn of item.additionalButtons; track btn.id) {
                    @if (!btn.hidden) {
                      <button
                        class="additional-btn"
                        mat-icon-button
                        [matTooltip]="btn.tooltip | translate"
                        (click)="btn.action?.()"
                        #additionalBtn
                      >
                        <mat-icon>{{ btn.icon }}</mat-icon>
                      </button>
                    }
                  }
                }

                <!-- Context menu for additional buttons -->
                @if (item.contextMenuItems && item.contextMenuItems.length > 0) {
                  <context-menu
                    [contextMenu]="contextMenuTemplate"
                    [leftClickTriggerEl]="additionalBtn"
                    [rightClickTriggerEl]="expandBtn"
                  ></context-menu>
                  <ng-template #contextMenuTemplate>
                    @for (contextItem of item.contextMenuItems; track contextItem.id) {
                      <button
                        mat-menu-item
                        (click)="contextItem.action?.()"
                      >
                        @if (contextItem.svgIcon) {
                          <mat-icon [svgIcon]="contextItem.svgIcon"></mat-icon>
                        } @else {
                          <mat-icon>{{ contextItem.icon }}</mat-icon>
                        }
                        {{ contextItem.label | translate }}
                      </button>
                    }
                  </ng-template>
                }
              </div>
            } @else {
              <!-- Single button for simple expandable items -->
              <button
                class="nav-link"
                [class.expanded]="isGroupExpanded(item)"
                [attr.title]="!isExpanded() && !isMobile() ? item.label : null"
                (click)="onItemClick(item)"
                [attr.aria-expanded]="isGroupExpanded(item)"
              >
                @if (item.svgIcon) {
                  <mat-icon
                    class="nav-icon"
                    [svgIcon]="item.svgIcon"
                  ></mat-icon>
                } @else {
                  <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
                }
                @if (isExpanded() || (isMobile() && showMobileMenu())) {
                  <span class="nav-label">{{ item.label | translate }}</span>
                }
                @if (item.badge && (isExpanded() || (isMobile() && showMobileMenu()))) {
                  <span class="nav-badge">{{ item.badge }}</span>
                }
                @if (
                  item.children &&
                  item.children.length > 0 &&
                  (isExpanded() || (isMobile() && showMobileMenu()))
                ) {
                  <svg
                    class="nav-chevron"
                    width="16"
                    height="16"
                    viewBox="0 0 16 16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M4 6l4 4 4-4" />
                  </svg>
                }
              </button>
            }
          }

          <!-- Children Items -->
          @if (item.children && item.children.length > 0) {
            <ul
              class="nav-children"
              [class.expanded]="isGroupExpanded(item)"
              [class.visible]="
                (isExpanded() || (isMobile() && showMobileMenu())) &&
                isGroupExpanded(item)
              "
              role="list"
            >
              @for (child of item.children; track child.id) {
                <!-- Use side-nav-item for work context items (projects/tags) -->
                @if (child.workContext && child.workContextType && child.defaultIcon) {
                  <li
                    class="nav-child-item work-context-item"
                    role="listitem"
                  >
                    <side-nav-item
                      [workContext]="child.workContext"
                      [type]="child.workContextType"
                      [defaultIcon]="child.defaultIcon"
                      [activeWorkContextId]="activeWorkContextId || ''"
                    ></side-nav-item>
                  </li>
                } @else {
                  <!-- Use regular nav item rendering for non-work-context items -->
                  <li
                    class="nav-child-item"
                    role="listitem"
                  >
                    @if (child.route) {
                      <a
                        [routerLink]="child.route"
                        routerLinkActive="active"
                        class="nav-child-link"
                        (click)="onItemClick(child)"
                      >
                        @if (child.svgIcon) {
                          <mat-icon
                            class="nav-icon"
                            [svgIcon]="child.svgIcon"
                          ></mat-icon>
                        } @else {
                          <mat-icon class="nav-icon">{{ child.icon }}</mat-icon>
                        }
                        <span class="nav-label">{{ child.label | translate }}</span>
                        @if (child.badge) {
                          <span class="nav-badge">{{ child.badge }}</span>
                        }
                      </a>
                    }
                    @if (!child.route) {
                      <button
                        class="nav-child-link"
                        (click)="onItemClick(child)"
                      >
                        @if (child.svgIcon) {
                          <mat-icon
                            class="nav-icon"
                            [svgIcon]="child.svgIcon"
                          ></mat-icon>
                        } @else {
                          <mat-icon class="nav-icon">{{ child.icon }}</mat-icon>
                        }
                        <span class="nav-label">{{ child.label | translate }}</span>
                        @if (child.badge) {
                          <span class="nav-badge">{{ child.badge }}</span>
                        }
                      </button>
                    }
                  </li>
                }
              }
            </ul>
          }
        </li>
      }
    }
  </ul>

  <!-- Resize Handle -->
  @if (config.resizable && !isMobile()) {
    <div
      class="resize-handle"
      [class.position-left]="config.position !== 'right'"
      [class.position-right]="config.position === 'right'"
      [class.collapsed-handle]="!isExpanded()"
      (mousedown)="onResizeStart($event)"
      [attr.aria-label]="'Resize sidebar'"
      role="separator"
    >
      <div class="resize-handle-line"></div>
    </div>
  }
</nav>
