<ng-container>
  @if (currentTask()?.issueWasUpdated) {
    <div
      @expand
      style="text-align: center"
    >
      <button
        (click)="hideUpdates()"
        color="accent"
        mat-raised-button
      >
        {{ translate(config()?.updateButtonLabel || '') }}
      </button>
    </div>
  }

  @if (config(); as cfg) {
    <div class="table-wrapper">
      <table class="issue-table">
        @for (field of visibleFields(); track trackByIndex($index)) {
          <tr [class.description-row]="field.type === IssueFieldType.MARKDOWN">
            <th>{{ translate(field.label) }}</th>
            <td
              [class.issue-description]="field.type === IssueFieldType.MARKDOWN"
              [class.summary]="field.field === 'summary' || field.field === 'title'"
            >
              @switch (field.type) {
                @case (IssueFieldType.TEXT) {
                  {{ getFieldValue(field, currentIssue()) }}
                }
                @case (IssueFieldType.LINK) {
                  @if (getFieldLink(field, currentIssue()); as link) {
                    <a
                      [href]="link"
                      target="_blank"
                    >
                      <strong>{{ getFieldValue(field, currentIssue()) }}</strong>
                    </a>
                  } @else {
                    <strong>{{ getFieldValue(field, currentIssue()) }}</strong>
                  }
                }
                @case (IssueFieldType.CHIPS) {
                  <mat-chip-listbox>
                    @for (
                      chip of getFieldValue(field, currentIssue());
                      track trackByIndex($index)
                    ) {
                      <mat-chip-option [title]="chip.description || ''">
                        {{ chip.name || chip }}
                      </mat-chip-option>
                    }
                  </mat-chip-listbox>
                }
                @case (IssueFieldType.MARKDOWN) {
                  @if (!isCollapsedIssueSummary() || field.field !== 'body') {
                    <div
                      [data]="getFieldValue(field, currentIssue())"
                      class="description markdown"
                      markdown
                    ></div>
                  }
                }
                @case (IssueFieldType.CUSTOM) {
                  @switch (field.customTemplate) {
                    @case ('jira-worklog') {
                      <span>
                        {{ getJiraTimeSpent() | msToString }} /
                        {{ getJiraTimeEstimate() | msToString }}
                      </span>
                    }
                    @case ('jira-subtasks') {
                      <!-- JIRA subtasks would need additional service integration -->
                    }
                    @case ('jira-related') {
                      <!-- JIRA related issues would need additional service integration -->
                    }
                    @case ('open-project-spent-time') {
                      <span>{{ getFieldValue(field, currentIssue()) }}</span>
                    }
                    @case ('redmine-spent-time') {
                      <div>
                        @if (hasRedmineSpentHours()) {
                          <span>{{ getRedmineSpentHours() }}h</span>
                        }
                        @if (hasRedmineTotalSpentHours()) {
                          <span>
                            ({{ translate('F.REDMINE.ISSUE_CONTENT.TOTAL') }}:
                            {{ getRedmineTotalSpentHours() }}h)
                          </span>
                        }
                      </div>
                    }
                  }
                }
              }
            </td>
          </tr>
        }
      </table>

      @if (hasComments()) {
        <div>
          @if (isCollapsedIssueComments() && cfg.hasCollapsingComments) {
            <div style="text-align: center">
              <button
                mat-stroked-button
                class="load-comments-and-all-data"
                (click)="showAllContent()"
              >
                <mat-icon>download</mat-icon>
                @if (isCollapsedIssueSummary()) {
                  <span
                    style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap"
                  >
                    {{
                      translate(
                        'F.GITHUB.ISSUE_CONTENT.LOAD_DESCRIPTION_AND_ALL_COMMENTS'
                      )
                    }}
                  </span>
                } @else {
                  {{
                    translate(cfg.loadAllCommentsLabel || '', { nr: getCommentsLength() })
                  }}
                }
              </button>
            </div>
            @if (lastComment()) {
              <h3 class="last-comment-headline">
                {{ translate(cfg.lastCommentLabel || '') }}
              </h3>
              <div class="comment isLastComment">
                @if (getCommentAvatar(lastComment(), cfg); as avatar) {
                  <img
                    [src]="avatar"
                    class="author-avatar"
                  />
                }
                <div class="name-and-comment-content">
                  <div>
                    <span class="author-name">{{
                      getCommentAuthor(lastComment(), cfg)
                    }}</span>
                    <span class="when">
                      {{ translate('F.GITHUB.ISSUE_CONTENT.AT') }}
                      {{ getCommentCreated(lastComment(), cfg) | date: 'short' }}
                    </span>
                  </div>
                  @if (getCommentBody(lastComment(), cfg); as body) {
                    @if (cfg.issueType === 'JIRA') {
                      <div
                        [innerHTML]="body | jiraToMarkdown | markdown | async"
                        class="markdown"
                      ></div>
                    } @else {
                      <div
                        [innerHTML]="body | markdown | async"
                        class="markdown"
                      ></div>
                    }
                  }
                </div>
              </div>
            }
          } @else {
            @for (
              comment of getComments() | sort: cfg.comments.sortField;
              track trackByIndex($index)
            ) {
              <div class="comment">
                @if (getCommentAvatar(comment, cfg); as avatar) {
                  <img
                    [src]="avatar"
                    class="author-avatar"
                  />
                }
                <div class="name-and-comment-content">
                  <div>
                    <span class="author-name">{{ getCommentAuthor(comment, cfg) }}</span>
                    <span class="when">
                      {{ translate('F.GITHUB.ISSUE_CONTENT.AT') }}
                      {{ getCommentCreated(comment, cfg) | date: 'short' }}
                    </span>
                  </div>
                  @if (getCommentBody(comment, cfg); as body) {
                    @if (cfg.issueType === 'JIRA') {
                      <div
                        [innerHTML]="body | jiraToMarkdown | markdown | async"
                        class="markdown"
                      ></div>
                    } @else {
                      <div
                        [innerHTML]="body | markdown | async"
                        class="markdown"
                      ></div>
                    }
                  }
                </div>
              </div>
            }
          }
        </div>
      }

      @if (cfg.writeCommentLabel) {
        <div style="text-align: center">
          <a
            [href]="config()?.getIssueUrl(currentIssue()) || ''"
            class="write-a-comment"
            color="primary"
            mat-stroked-button
            target="_blank"
          >
            <mat-icon>textsms</mat-icon>
            {{ translate(cfg.writeCommentLabel) }}
          </a>
        </div>
      }
    </div>
  }
</ng-container>
